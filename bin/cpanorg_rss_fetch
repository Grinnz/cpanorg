#!/usr/bin/env perl

use strict;
use warnings;
use local::lib;
use File::Temp;
use XML::RSS;
use JSON;
use LWP::Simple qw(mirror);
use File::Path qw(mkpath);

mkpath 'data', 0755 unless -e 'data';

process_rss(
    {   out  => 'data/recent.rdf',
        file => get_rss( { url => "http://search.cpan.org/uploads.rdf", } )
    }
);

sub process_rss {
    my $conf = shift;

    unless ( -r $conf->{file} ) {
        warn "Could not find $conf->{file}";
        return;
    }

    rename( $conf->{file}, $conf->{out} );

    my $rss = XML::RSS->new;
    $rss->parsefile( $conf->{out} );
    my $items = $rss->{'items'};

    my $j = JSON->new();
    
    my $json_file;
    ($json_file = $conf->{out}) =~ s/\.rdf$/.json/;

    open my $fh, ">:utf8", $json_file
        or die "Could not open $json_file: $!";
    print $fh $j->encode($items);
    close $fh;
}

sub get_rss {
    my $conf = shift;

    my $tmp_file;

    {
        my $fh = File::Temp->new();
        $tmp_file = $fh->filename;
    }

    mirror($conf->{url}, $tmp_file);

    return $tmp_file;

}

